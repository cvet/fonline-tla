namespace MapTime
{

///@ Setting Common int32 TimeMultiplier
///@ Setting Common int32 StartYear

///@ Property Game Common int32 Year Mutable NoSync
///@ Property Game Common int32 Month Mutable NoSync
///@ Property Game Common int32 Day Mutable NoSync
///@ Property Game Common int32 Hour Mutable NoSync
///@ Property Game Common int32 Minute Mutable NoSync
///@ Property Game Common int32 Second Mutable NoSync

///@ Property Map Server bool FixedTime Mutable Persistent

// [[ModuleInit]]
void ModuleInit()
{
#if SERVER
    Game.OnMapInit.Subscribe(OnMapInit);
#endif

    UpdateDateTime();
    Game.StartTimeEvent(Time::Asap(), Time::Milliseconds(500), UpdateDateTime);
}

// [[TimeEvent]]
void UpdateDateTime()
{
    nanotime time = Game.PackTime(Settings.StartYear, 1, 10, 15, 0, 0, 0, 0, 0);

    time += Time::Milliseconds(Game.SynchronizedTime.milliseconds * Settings.TimeMultiplier);

    int year = 0;
    int month = 0;
    int day = 0;
    int hour = 0;
    int minute = 0;
    int second = 0;
    int millisecond = 0;
    int microsecond = 0;
    int nanosecond = 0;
    Game.UnpackTime(time, year, month, day, hour, minute, second, millisecond, microsecond, nanosecond);

    Game.Year = year;
    Game.Month = month;
    Game.Day = day;
    Game.Hour = hour;
    Game.Minute = minute;
    Game.Second = second;

#if CLIENT
    Game.GlobalDayTime = hour * 60 + minute;
#endif
}

#if SERVER

// [[Event]]
void OnMapInit(Map map, bool firstTime)
{
    if (!map.FixedTime) {
        map.FixedDayTime = 0;
    }
}

#endif

}
