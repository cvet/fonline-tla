namespace Poster
{

#if SERVER

// Author: rifleman17
// Постеры, которые можно вешать на стену
// Игрок использует свернутый плакат в инвентаре, если стоит на нужном гексе, то на стену рядом вешается плакат
// Гексы расставил Dagnir на картах личных складов

///@ Property Item PrivateServer hstring PosterSNWall
///@ Property Item PrivateServer hstring PosterEWWall

#define STR_USED        (5)
#define STR_WRONG_WALL  (6)

#define ENTRY_SN_POSTER ("1752")
#define ENTRY_EW_POSTER ("1704")

// clang-format off

int[][] posters =
/*  Info, Cost, SN стена, EW стена*/
{
    { 2, 1000, Content::Item::poster_2.hash, Content::Item::poster_3.hash },
    { 4, 2000, Content::Item::poster_4.hash, Content::Item::poster_5.hash },
    { 6, 3000, Content::Item::poster_6.hash, Content::Item::poster_7.hash },
    { 8, 4000, Content::Item::poster_8.hash, Content::Item::poster_9.hash },
    { 10, 5000, Content::Item::poster_bundle.hash, Content::Item::misc_0625.hash },
    { 12, 9000, Content::Item::misc_0626.hash, Content::Item::misc_0627.hash },
    { 14, 12000, Content::Item::misc_0628.hash, Content::Item::misc_0629.hash },
    { 16, 15000, Content::Item::misc_0630.hash, Content::Item::misc_0631.hash },
    { 18, 22000, Content::Item::misc_0632.hash, Content::Item::misc_0633.hash }
};

// clang-format on

void _BundleInit(Item item, bool firstTime)
{
    if (firstTime) {
        int idx = Game.Random(0, posters.length() - 1);
        item.Cost = posters[idx][1];
        item.Info = posters[idx][0];
        item.PosterSNWall = hstring_fromHash(posters[idx][2]);
        item.PosterEWWall = hstring_fromHash(posters[idx][3]);
    }

    item.OnCritterUse.Subscribe(_BundleUse);
}

bool _BundleUse(Item item, Critter cr, int param)
{
    Map map = cr.GetMap();
    if (valid(map)) {
        Entrance::Entry[] entries = {};
        entries.insertLast(Entrance::ParseEntries(map, hstring(ENTRY_SN_POSTER)));
        entries.insertLast(Entrance::ParseEntries(map, hstring(ENTRY_EW_POSTER)));
        mpos hex = cr.Hex;
        for (int i = 0; i < entries.length(); i++) {
            if (entries[i].Hex == cr.Hex) {
                if (entries[i].Name == hstring(ENTRY_EW_POSTER)) {
                    map.MoveHexByDir(hex, 5, 1);
                    map.MoveHexByDir(hex, 4, 1);
                    Item poster = map.AddItem(hex, item.PosterSNWall, 1);
                    if (valid(poster)) {
                        poster.NoHighlight = true;
                    }
                    Messaging::Info(cr, TextPackName::Text, STR_USED);
                    Game.DestroyItem(item);
                    return true;
                }
                if (entries[i].Name == hstring(ENTRY_SN_POSTER)) {
                    map.MoveHexByDir(hex, 1, 1);
                    Item poster = map.AddItem(hex, item.PosterEWWall, 1);
                    if (valid(poster)) {
                        poster.NoHighlight = true;
                    }
                    Messaging::Info(cr, TextPackName::Text, STR_USED);
                    Messaging::Info(cr, TextPackName::Text, STR_USED);
                    Game.DestroyItem(item);
                    return true;
                }
            }
        }
        Messaging::Info(cr, TextPackName::Text, STR_WRONG_WALL);
        return true;
    }
    return false;
}

#endif

}
