namespace MapV15Village
{

#if SERVER

// Author: rifleman17
// Vault15 ground map script. Special phrases for pedobear karma.

// Проваливай отсюда, извращенец.Посмотрите на эту мразь! Он набрался наглости вернуться сюда!таким как ты в польше химическую кастрацию делают, Иди \
// в жопу извращенец!И откуда вы, мрази, беретесь.Охотники уже идут за тобой. Ты сдохнешь!
#define STR_SAY     (5905)

#define DIST_FIND   (10)

#define _IsGumanoid #(npc)(npc.BodyType == BodyTypes::Men || npc.BodyType == BodyTypes::Women || npc.BodyType == BodyTypes::Children)

void _MapInit(Map map, bool firstTime)
{
    map.OnCritterIn.Subscribe(_MapInCritter);
}

void _MapInCritter(Map map, Critter cr)
{
    if (cr.ControlledByPlayer && cr.KarmaPerkPedobear > 1) {
        cr.StartTimeEvent(Time::Seconds(20), cte_NpcReact);
    }
}

void cte_NpcReact(Critter cr)
{
    Map map = cr.GetMap();
    if (!valid(map) || map.ProtoId != Content::Map::v15_village) {
        return;
    }

    Critter[] critters = map.GetCritters(cr.Hex, DIST_FIND, CritterFindType::NonDeadNpc);
    if (!critters.isEmpty()) {
        Critter npc = critters[0];
        if (_IsGumanoid(npc)) {
            npc.SayMsg(SAY_NORM, TextPackName::Text, STR_SAY);
        }
    }
    tick_t delayTicks = Time::Seconds(20);
    if (delayTicks > 0) {
        Game.RepeatCurrentTimeEvent(delayTicks);
    }
}

// Карма "Педобир"=2 устанавливается в 2 через 8 реальных часов, чтобы игрок сначала успел довести девочку домой. После этого, за персонажем охотятся баунти
void r_DelayKarma(Critter player, Critter npc)
{
    player.StartTimeEvent(Time::RealHour(8), cte_IncKarma);
}

void cte_IncKarma(Critter cr)
{
    cr.KarmaPerkPedobear = 2;
    return;
}

#endif

}
